name: Kernel Builder

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Repository'
        required: true
        default: 'https://github.com/Lothlorien-playground/android_kernel_common_perf-4.14.git'
      KERNEL_BRANCH:
        description: 'Kernel Branch'
        required: true
        default: 'Maiar-VNL'

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
            git git-lfs gnupg gperf imagemagick lib32readline-dev lib32z1-dev \
            libdw-dev libelf-dev lz4 libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
            lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev

      - name: Clone Kernel Repo
        env:
          GH_TOKEN: ${{ secrets.KERNEL }}
        run: |
          REPO_URL="${{ inputs.KERNEL_REPO }}"
          AUTH_REPO_URL="${REPO_URL/https:\/\//https:\/\/${GH_TOKEN}@}"
          git clone --depth=1 --branch "${{ inputs.KERNEL_BRANCH }}" --recursive "$AUTH_REPO_URL" kernel

      - name: Download Clang Toolchain (r547379 - Clang 20)
        run: |
          mkdir -p /home/runner/linux-x86/clang
          cd /home/runner/linux-x86/clang
          echo "Downloading Clang r547379..."
          curl -L \
            "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz" \
            -o clang.tar.gz
          echo "Extracting..."
          tar -xf clang.tar.gz
          rm clang.tar.gz
          echo "CLANG_PATH=/home/runner/linux-x86/clang" >> $GITHUB_ENV

      - name: Run build.sh
        run: |
          cd kernel
          git config user.name "galadriel1402"
          git config user.email "galadriel1402@gmail.com"
          bash ksun_susfs.sh && bash build.sh "${{ env.CLANG_PATH }}"

      - name: Upload Kernel Zip
        uses: softprops/action-gh-release@v1
        with:
          files: kernel/Maiar-*.zip
          name: Maiar Kernel - ${{ github.run_id }}
          tag_name: build-${{ github.run_id }}
          body: |
            **Device:** sweet  
            **Branch:** ${{ inputs.KERNEL_BRANCH }}  
            **Clang Version:** clang-r547379 (Clang 20)
